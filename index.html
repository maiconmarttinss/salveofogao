<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Salve o Fog√£o das vendas!</title>
<style>
  :root{ --bg:#0d1117; --panel:#151b23; --line:#232a34; --fg:#e6edf3; --mut:#9aa0a6; --acc:#3ddc97; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:1400px;margin:0 auto;padding:20px;display:flex;flex-direction:column;gap:12px;align-items:center;position:relative}
  h1{margin:0;font-size:clamp(18px,3.5vw,26px)}
  .hud{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .left,.right{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{color:var(--mut);font-size:14px}
  select,button{background:var(--panel);color:var(--fg);border:1px solid var(--line);padding:8px 10px;border-radius:10px;cursor:pointer;font-weight:600}
  button:hover{filter:brightness(1.06)}
  .score{color:var(--mut);font-weight:600}
  .badge{background:#202938;border:1px solid #2b3442;border-radius:999px;padding:4px 10px;color:var(--mut);font-size:12px}

  canvas{
    width:100%;
    max-width:1280px;
    aspect-ratio:16/9;
    background:#0f1622;
    border:1px solid var(--line);
    border-radius:16px;
    display:block;
  }

  .help{color:var(--mut);font-size:13px;line-height:1.5}
  .touch{display:flex;gap:8px;margin-top:6px}
  .touch .btn{flex:1}

  /* modal para registrar nome */
  .name-modal{
    position:absolute; inset:0;
    display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.45); border-radius:16px;
  }
  .name-card{
    background:#0f1622; border:1px solid var(--line); border-radius:14px; padding:18px; width:min(92vw,380px);
    box-shadow:0 10px 30px rgba(0,0,0,.4);
  }
  .name-card h3{margin:0 0 12px;font-size:18px}
  .row{display:flex; gap:8px}
  .name-card input{
    flex:1; background:#151b23; color:var(--fg); border:1px solid var(--line);
    padding:10px 12px; border-radius:10px; font-weight:700; letter-spacing:.5px; text-transform:uppercase;
  }
  .name-card small{display:block;color:var(--mut);margin-top:6px}

  @media (max-width: 768px){
    .wrap{max-width:none;padding:12px}
    canvas{max-width:100vw}
    h1{font-size:18px}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>SALVE O FOG√ÉO DAS VENDAS PRO FOREST!</h1>

  <div class="hud">
    <div class="left">
      <span class="badge">Espa√ßo / ‚Üë / Enter / clique / toque</span>
      <label for="diff">Dificuldade:</label>
      <select id="diff">
        <option value="easy">F√°cil</option>
        <option value="normal" selected>M√©dio</option>
        <option value="hard">Dif√≠cil</option>
      </select>
      <button id="start" class="btn">‚ñ∂Ô∏è Jogar / Reiniciar</button>
      <button id="pause" class="btn">‚è∏Ô∏è Pausar</button>
      <button id="mute"  class="btn">üîä Som: ON</button>
      <button id="resetBest" class="btn">‚Ü∫ Zerar recorde</button>
    </div>
    <div class="right">
      <span id="score" class="score">Jogadores salvos: 0</span>
      <span id="best" class="score">Recorde: 0</span>
    </div>
  </div>

  <canvas id="game"></canvas>

  <div class="help">
    Pulo em toque/clique/tecla. Passe no meio dos ‚Äúcanos vermelhos‚Äù.
    <div class="touch">
      <button id="flapBtn" class="btn">üïäÔ∏è Bater asa</button>
    </div>
  </div>

  <!-- Modal para nome -->
  <div id="nameModal" class="name-modal">
    <div class="name-card">
      <h3>Registrar pontua√ß√£o</h3>
      <div class="row">
        <input id="playerName" type="text" maxlength="8" placeholder="SEU NOME (8 letras)" />
        <button id="saveScoreBtn">Salvar</button>
      </div>
      <small>M√°x. 8 caracteres. Deixe vazio para ‚ÄúAN√îNIMO‚Äù.</small>
    </div>
  </div>
</div>

<script>
/* ===== Util ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
function aabbInset(ax,ay,aw,ah, bx,by,bw,bh, inset){
  return (ax+inset) < (bx+bw-inset) &&
         (ax+aw-inset) > (bx+inset) &&
         (ay+inset) < (by+bh-inset) &&
         (ay+ah-inset) > (by+inset);
}
function loadImage(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
function canvasPos(evt){
  const rect = canvas.getBoundingClientRect();
  const scaleX = world.w / rect.width;
  const scaleY = world.h / rect.height;
  const x = (evt.clientX - rect.left) * scaleX;
  const y = (evt.clientY - rect.top) * scaleY;
  return {x,y};
}
function pointInRect(p, r){ return p.x>=r.x && p.x<=r.x+r.w && p.y>=r.y && p.y<=r.y+r.h; }

/* ===== Setup ===== */
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
const UI={
  diff:document.getElementById('diff'),
  start:document.getElementById('start'),
  pause:document.getElementById('pause'),
  mute:document.getElementById('mute'),
  flapBtn:document.getElementById('flapBtn'),
  score:document.getElementById('score'),
  best:document.getElementById('best'),
  resetBest:document.getElementById('resetBest'),
};
const UI_WRAP=document.querySelector('.wrap');
const MODAL=document.getElementById('nameModal');
const NAME_INPUT=document.getElementById('playerName');
const SAVE_BTN=document.getElementById('saveScoreBtn');

let state='menu';
let running=false, paused=false, last=0, assetsReady=false;

const world={ w:1280, h:720, groundH:84, gravity:1800, scroll:0 };
let SCALE=1;

/* ===== Responsivo ===== */
function fitCanvas(){
  const dpr=window.devicePixelRatio||1;
  const cssW=Math.min(UI_WRAP.clientWidth,1280);
  const cssH=Math.round(cssW*9/16);
  canvas.style.width=cssW+'px';
  canvas.style.height=cssH+'px';
  canvas.width=Math.round(cssW*dpr);
  canvas.height=Math.round(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  world.w=cssW; world.h=cssH;
  SCALE=world.h/720;
  world.groundH=Math.round(84*SCALE);
  world.gravity=1800*SCALE;
  if(!running||paused||state!=='playing') draw(false);
}
window.addEventListener('resize', fitCanvas);

/* ===== Game data ===== */
let bird=null, pipes=[], particles=[], powerups=[], turboTimer=0;
let score=0, lives=3, newRecord=false;
let countdown=0; // 3‚Üí2‚Üí1
let shake=0, flash=0; // c√¢mera e flash hit
let toast=null; // {msg,t}
const birdBase={w:56,h:56};
let best=Number(localStorage.getItem('flap_best')||0);
UI.best.textContent=`Recorde: ${best}`;
let endMsg='';
let overlayButtons=null; // {restart,menu,share}

/* ===== Dificuldades ===== */
function getDiffTable(){
  const s=SCALE;
  return {
    easy:   { gap:190*s, spacing:360*s, speed:280*s },
    normal: { gap:170*s, spacing:330*s, speed:320*s },
    hard:   { gap:150*s, spacing:300*s, speed:360*s },
  };
}
function Dcur(){
  const D=getDiffTable()[diff];
  return turboTimer>0 ? { ...D, speed: D.speed*1.35 } : D;
}
let diff='normal', spawnTimer=0, spawnEvery=1000, powerSpawn=0;

/* ===== Assets ===== */
const ASSETS={ bird:null, marinakis:null, forest:null, bg:null, menu:null, liberta:null };
Promise.all([
  loadImage('botafogo.png'),
  loadImage('marinakis.png'),
  loadImage('nf.png'),
  loadImage('bgtextorfase.png'),
  loadImage('bg.png'),
  loadImage('liberta.png'),
]).then(([b,m,f,bg,menu,lib])=>{
  ASSETS.bird=b; ASSETS.marinakis=m; ASSETS.forest=f; ASSETS.bg=bg; ASSETS.menu=menu; ASSETS.liberta=lib;
  assetsReady=true; draw(false);
}).catch(()=>{ assetsReady=false; });

/* ===== √Åudio ===== */
let audioMuted=false, bgmUnlocked=false;
const SFX={
  flap:new Audio('sfx/flap.mp3'),
  point:new Audio('sfx/point.mp3'),
  hit:new Audio('sfx/hit.mp3'),
  gameover:new Audio('sfx/gameover.mp3')
};
Object.values(SFX).forEach(a=>{ a.preload='auto'; a.volume=0.85; });

const BGM=new Audio('music/theme.mp3'); BGM.loop=true; BGM.volume=0.35; BGM.preload='auto';
function unlockBGM(){ if(bgmUnlocked) return; BGM.play().then(()=>{BGM.pause();BGM.currentTime=0;bgmUnlocked=true;}).catch(()=>{}); }
function playBGM(restart=false){ if(audioMuted) return; if(restart) BGM.currentTime=0; BGM.play().catch(()=>{}); }
function setMuted(m){ audioMuted=m; BGM.muted=m; Object.values(SFX).forEach(a=>a.muted=m); UI.mute.textContent=m?'üîá Som: OFF':'üîä Som: ON'; }
function playSfx(a){ if(audioMuted) return; try{ a.currentTime=0; a.play(); }catch(e){} }
window.addEventListener('pointerdown', unlockBGM);
window.addEventListener('keydown', unlockBGM);

/* ===== Ranking ===== */
function getTop(){
  try{
    const raw=localStorage.getItem('flap_top')||'[]';
    const arr=JSON.parse(raw);
    if(arr.length && typeof arr[0]==='number') return arr.map(s=>({n:'AN√îNIMO', s}));
    return arr;
  }catch(_){ return []; }
}
function saveTop(name, s){
  const n=(name||'AN√îNIMO').toUpperCase().slice(0,8);
  const arr=getTop(); arr.push({n, s});
  arr.sort((a,b)=>b.s - a.s); while(arr.length>5) arr.pop();
  localStorage.setItem('flap_top', JSON.stringify(arr));
  best=Math.max(best, s); localStorage.setItem('flap_best', String(best));
  UI.best.textContent=`Recorde: ${best}`;
}

/* ===== HUD ===== */
function updateHUD(){
  UI.score.textContent=`Jogadores salvos: ${score}`;
  UI.best.textContent=`Recorde: ${best}`;
}

/* ===== Fluxo ===== */
function reset(keepLives=false){
  diff=UI.diff.value;
  world.scroll=0; turboTimer=0; newRecord=false; endMsg='';
  if(!keepLives) lives=3;
  countdown=0; shake=0; flash=0;
  const bw=Math.round(birdBase.w*SCALE), bh=Math.round(birdBase.h*SCALE);
  bird={ x:Math.round(world.w*0.1875), y:world.h/2-Math.round(40*SCALE), w:bw, h:bh, vy:0, flap:520*SCALE, maxFall:900*SCALE };
  pipes=[]; particles=[]; powerups=[]; score=0; spawnTimer=0; spawnEvery=1000; powerSpawn=0;
  overlayButtons=null;
  updateHUD();
}
function start(){
  hideNameModal();
  reset(false); state='playing'; running=true; paused=false; last=performance.now();
  unlockBGM(); playBGM(true);
  requestAnimationFrame(loop);
}
function goMenu(){ state='menu'; running=false; paused=false; draw(false); }
function pauseToggle(){
  if(state!=='playing') return;
  paused=!paused; state=paused?'paused':'playing';
  if(paused){ try{BGM.pause();}catch(e){}; draw(true); return; }
  unlockBGM(); playBGM(false); last=performance.now(); requestAnimationFrame(loop);
}

/* ===== Vida perdida -> countdown 3-2-1 e restart ===== */
function loseLife(){
  spawnExplosion(bird.x+bird.w/2, bird.y+bird.h/2, 'hit');
  triggerShakeFlash('hit');
  lives = Math.max(0, lives-1);
  if(lives<=0){ gameOver(); return; }
  // inicia contagem
  countdown = 3; // segundos
  state = 'countdown';
  try{BGM.pause();}catch(e){}
}

/* ===== Game Over ===== */
function gameOver(){
  running=false; state='gameover';
  try{BGM.pause();}catch(e){}
  spawnExplosion(bird.x+bird.w/2, bird.y+bird.h/2, 'gameover');
  triggerShakeFlash('gameover');
  playSfx(SFX.gameover);

  endMsg = `Voc√™ salvou ${score} jogador${score===1?'':'es'} do elenco`;
  showNameModal();
  draw(true);
}

/* ===== Entradas ===== */
function flapOrStart(){
  if(state==='menu'){ start(); return; }
  if(state!=='playing') return;
  bird.vy = -bird.flap; playSfx(SFX.flap);
  spawnFlapFX(); // fogo laranja no flap
  if(turboTimer>0){ // rastro turbo
    for(let k=0;k<6;k++){
      particles.push({kind:'blaze',x:bird.x,y:bird.y+bird.h/2,vx:rand(-220,-120)*SCALE,vy:rand(-40,40)*SCALE,g:160*SCALE,alpha:1,fade:rand(2.2,3.2),life:rand(0.18,0.35)});
    }
  }
}
window.addEventListener('keydown',(e)=>{
  if(e.code==='Space'||e.code==='ArrowUp'||e.code==='Enter'){ e.preventDefault(); flapOrStart(); }
  else if(e.code==='KeyP'){ pauseToggle(); }
});
canvas.addEventListener('mousedown',(e)=>{
  const p = canvasPos(e);
  if(state==='menu'){ start(); return; }
  if(state==='gameover' && overlayButtons){
    if(pointInRect(p, overlayButtons.restart)) { start(); return; }
    if(pointInRect(p, overlayButtons.menu))    { goMenu(); return; }
    if(pointInRect(p, overlayButtons.share))   { shareScore(); return; }
  }
  if(state==='playing') flapOrStart();
});
canvas.addEventListener('touchstart',(e)=>{
  e.preventDefault();
  const t = e.changedTouches[0];
  const p = {x:t.clientX, y:t.clientY};
  // converter para coords canvas
  const pos = canvasPos({clientX:p.x, clientY:p.y});
  if(state==='menu'){ start(); return; }
  if(state==='gameover' && overlayButtons){
    if(pointInRect(pos, overlayButtons.restart)) { start(); return; }
    if(pointInRect(pos, overlayButtons.menu))    { goMenu(); return; }
    if(pointInRect(pos, overlayButtons.share))   { shareScore(); return; }
  }
  if(state==='playing') flapOrStart();
}, {passive:false});

UI.flapBtn.addEventListener('click', flapOrStart);
UI.start.addEventListener('click', start);
UI.pause.addEventListener('click', pauseToggle);
UI.mute.addEventListener('click', ()=>setMuted(!audioMuted));
UI.diff.addEventListener('change', ()=>{ if(state!=='playing') reset(false); });
UI.resetBest.addEventListener('click', ()=>{
  localStorage.removeItem('flap_best');
  best = 0; updateHUD();
});

/* Pausa autom√°tica ao trocar de aba */
document.addEventListener('visibilitychange', ()=>{
  if(document.hidden && state==='playing'){ pauseToggle(); }
});

/* ===== Modal Nome ===== */
function showNameModal(){ MODAL.style.display='flex'; NAME_INPUT.value=''; NAME_INPUT.focus(); }
function hideNameModal(){ MODAL.style.display='none'; }
SAVE_BTN.addEventListener('click', ()=>{
  const name = NAME_INPUT.value.trim().toUpperCase().slice(0,8) || 'AN√îNIMO';
  saveTop(name, score);
  hideNameModal();
  goMenu(); // voltar para o menu depois de salvar
});
NAME_INPUT.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ SAVE_BTN.click(); }});

/* ===== Share ===== */
async function shareScore(){
  const url = new URL(location.href);
  url.searchParams.set('score', String(score));
  const shareUrl = url.toString();
  const text = `Eu salvei ${score} jogadores no "Salve o Fog√£o"! Vem tentar me passar:`;
  try{
    if(navigator.share){
      await navigator.share({ title:'Salve o Fog√£o', text, url:shareUrl });
      setToast('Compartilhado!');
    }else if(navigator.clipboard){
      await navigator.clipboard.writeText(`${text} ${shareUrl}`);
      setToast('Link copiado!');
    }else{
      alert(`${text} ${shareUrl}`);
    }
  }catch(_){}
}
function setToast(msg, secs=1.6){ toast={msg, t:secs}; }

/* ===== Loop ===== */
function loop(ts){
  if(!running||paused) return;
  const dt=Math.min(0.033,(ts-last)/1000); last=ts;
  update(dt); draw(false); requestAnimationFrame(loop);
}

/* ===== Update ===== */
function update(dt){
  const D=Dcur();

  if(toast){ toast.t -= dt; if(toast.t<=0) toast=null; }

  if(shake>0) shake = Math.max(0, shake - dt);
  if(flash>0) flash = Math.max(0, flash - dt*2.4);

  if(state==='countdown'){
    countdown -= dt;
    if(countdown <= 0){
      // reinicia a rodada mantendo vidas restantes
      reset(true);
      state='playing';
      unlockBGM(); playBGM(true);
    }
    return; // congela mundo durante a contagem
  }

  world.scroll += D.speed*dt;

  if(turboTimer>0) turboTimer -= dt;

  // F√≠sica
  bird.vy = clamp(bird.vy + world.gravity*dt, -9999, bird.maxFall);
  bird.y  += bird.vy*dt;

  const topLimit=Math.round(8*SCALE), groundY=world.h-world.groundH;
  if(bird.y<topLimit){ bird.y=topLimit; bird.vy=0; }

  // ch√£o => perde vida
  if(bird.y + bird.h > groundY){ loseLife(); return; }

  // Spawns
  spawnTimer += dt*1000;
  if(spawnTimer>=spawnEvery){ spawnTimer=0; spawnEvery=D.spacing*(1000/D.speed); spawnPipe(D); }

  powerSpawn += dt;
  if(powerSpawn > rand(7,10)){ powerSpawn=0; spawnPowerUp(); }

  // Pipes
  for(let i=pipes.length-1;i>=0;i--){
    const p=pipes[i]; p.x -= D.speed*dt;

    // pontua√ß√£o ao passar
    if(!p.counted && !p.isTop && (p.x + p.w) < bird.x){
      p.counted=true; score++; playSfx(SFX.point);

      // ‚úÖ recorde em qualquer vida
      if(score > best){
        best = score;
        localStorage.setItem('flap_best', String(best));
        newRecord = true;
        updateHUD();
      } else {
        updateHUD();
      }
    }

    // colis√£o (com folga)
    if(aabbInset(bird.x,bird.y,bird.w,bird.h, p.x,p.y,p.w,p.h, Math.max(2,4*SCALE))){
      loseLife();
      return;
    }

    if(p.x + p.w < -120*SCALE) pipes.splice(i,1);
  }

  // Power-ups
  for(let i=powerups.length-1;i>=0;i--){
    const u=powerups[i];
    u.x -= D.speed*dt;
    if(aabbInset(bird.x,bird.y,bird.w,bird.h, u.x,u.y,u.w,u.h, 3*SCALE)){
      turboTimer = 6; // 6s turbo
      for(let k=0;k<18;k++){ particles.push({kind:'blaze',x:bird.x,y:bird.y+bird.h/2,vx:rand(-240,-120)*SCALE,vy:rand(-80,80)*SCALE,g:160*SCALE,alpha:1,fade:rand(2.2,3.4),life:rand(0.25,0.45)}); }
      powerups.splice(i,1);
      continue;
    }
    if(u.x + u.w < -40*SCALE) powerups.splice(i,1);
  }

  // Part√≠culas (atualiza√ß√£o)
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.vy = (p.vy||0) + (p.g||0)*dt;
    p.x += (p.vx||0)*dt; p.y += (p.vy||0)*dt;
    p.life = (p.life||0) - dt;
    p.alpha = (p.alpha ?? 1) - (p.fade||2)*dt*0.5;
    if(p.life<=0 || p.alpha<=0) particles.splice(i,1);
  }
}

/* ===== Spawns ===== */
function spawnPipe(D){
  const margin=Math.round(40*SCALE);
  const groundY=world.h-world.groundH;
  const minY=margin+Math.round(40*SCALE);
  const maxY=groundY-margin-D.gap-Math.round(40*SCALE);
  const yTopBottom=rand(minY,maxY);
  const pipeW=Math.round(76*SCALE);

  const skin = Math.random()<0.5 ? 'marinakis' : 'nf';

  pipes.push({ x:world.w+20*SCALE, y:0, w:pipeW, h:yTopBottom, isTop:true,  skin });
  pipes.push({ x:world.w+20*SCALE, y:yTopBottom+D.gap, w:pipeW, h:groundY-(yTopBottom+D.gap), isTop:false, counted:false, skin });
}
function spawnPowerUp(){
  const size=Math.round(44*SCALE);
  const groundY=world.h-world.groundH;
  const y=rand(60*SCALE, groundY-140*SCALE);
  powerups.push({ x:world.w+30*SCALE, y, w:size, h:size, rot:0 });
}

/* ===== Efeitos ===== */
function spawnFlapFX(){
  const baseX = bird.x - 4*SCALE, baseY = bird.y + bird.h/2;
  // fogo (c√≠rculos com gradiente + fa√≠scas + fumacinha)
  for(let i=0;i<10;i++){
    particles.push({ kind:'fire', x:baseX+rand(-3,3)*SCALE, y:baseY+rand(-4,4)*SCALE,
      vx:rand(-120,-40)*SCALE, vy:rand(-40,60)*SCALE, g:60*SCALE, size:rand(6,12)*SCALE,
      alpha:1, fade:rand(1.8,2.6), life:rand(0.25,0.45), hue:rand(20,45)
    });
  }
  for(let i=0;i<12;i++){
    particles.push({ kind:'spark', x:baseX, y:baseY, vx:rand(-260,-120)*SCALE, vy:rand(-80,80)*SCALE,
      g:220*SCALE, len:rand(6,16)*SCALE, alpha:1, fade:rand(2.4,3.4), life:rand(0.18,0.35),
      hue:rand(25,40), width:rand(1,2)*SCALE
    });
  }
  for(let i=0;i<4;i++){
    particles.push({ kind:'smoke', x:baseX+rand(-4,2)*SCALE, y:baseY+rand(-3,3)*SCALE, vx:rand(-50,-20)*SCALE,
      vy:rand(-10,20)*SCALE, g:-5*SCALE, size:rand(8,14)*SCALE, alpha:0.35, fade:rand(0.6,0.9), life:rand(0.5,0.8)
    });
  }
}
function spawnExplosion(x,y,type){
  const N = type==='gameover'? 60 : 36;
  for(let i=0;i<N;i++){
    const a=rand(0,Math.PI*2);
    const sp=rand(140, type==='gameover'? 360:280) * SCALE;
    particles.push({
      kind:'fire', x, y,
      vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, g:260*SCALE*(type==='gameover'?1.0:0.8),
      size:rand(6,14)*SCALE, alpha:1, fade:rand(2.0,3.2), life:rand(0.35,0.7), hue:rand(15,40)
    });
  }
}
function triggerShakeFlash(kind){
  shake = (kind==='gameover') ? 0.6 : 0.35;   // dura√ß√£o
  flash = 0.55;                               // alpha inicial
}

/* ===== Draw ===== */
function draw(showOverlay){
  ctx.clearRect(0,0,world.w,world.h);

  const doShake = shake>0;
  if(doShake){
    const maxAmp = 16*SCALE;                    // amplitude m√°xima
    const t = (state==='gameover') ? (shake/0.6) : (shake/0.35);
    const amp = maxAmp * t;
    ctx.save();
    ctx.translate(rand(-amp,amp), rand(-amp,amp));
  }

  if(state==='menu'){ drawMenu(); if(doShake) ctx.restore(); return; }

  drawBackground();
  for(const p of pipes) drawPipe(p);
  drawGround();
  drawPowerUps();
  drawBird();
  drawLivesIcons();   // √≠cones de vidas (canto superior)

  // part√≠culas (render)
  ctx.save(); ctx.globalCompositeOperation='lighter';
  for(const p of particles){
    const a=Math.max(0,Math.min(1,p.alpha||1));
    if(p.kind==='fire'){
      const r=p.size;
      const grad=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,r);
      grad.addColorStop(0,`rgba(255,255,200,${0.9*a})`);
      grad.addColorStop(0.45,`hsla(${p.hue||30},100%,55%,${0.7*a})`);
      grad.addColorStop(1,`rgba(0,0,0,0)`);
      ctx.fillStyle=grad; ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
    }else if(p.kind==='spark'){
      ctx.lineWidth=Math.max(1,p.width||1); ctx.strokeStyle=`hsla(${p.hue||30},100%,60%,${0.9*a})`;
      ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x+(p.vx*0.03), p.y+(p.vy*0.03)); ctx.stroke();
    }else if(p.kind==='smoke'){
      const r=p.size*(1+(0.6-(p.life||0))); ctx.fillStyle=`rgba(120,140,160,${0.25*a})`;
      ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
    }else if(p.kind==='blaze'){
      ctx.lineWidth=Math.max(1,1.6*SCALE); ctx.strokeStyle=`rgba(80,180,255,${0.9*a})`;
      ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(p.x+(p.vx*0.03), p.y+(p.vy*0.03)); ctx.stroke();
    }
  }
  ctx.restore();

  if(doShake){ ctx.restore(); }

  // flash
  if(flash>0){
    ctx.fillStyle=`rgba(255,255,255,${Math.min(1,flash)})`;
    ctx.fillRect(0,0,world.w,world.h);
  }

  // banner ‚ÄúNovo recorde!‚Äù
  if(newRecord && state==='playing'){
    const txt='üéâ Novo recorde!';
    ctx.font=`800 ${Math.round(24*SCALE)}px system-ui`; const w=ctx.measureText(txt).width;
    const x=(world.w-w)/2 - 18*SCALE, y=28*SCALE, bw=w+36*SCALE, bh=34*SCALE;
    ctx.fillStyle='rgba(0,0,0,.45)'; roundRect(x,y,bw,bh,10*SCALE,true);
    ctx.strokeStyle='#3ddc97'; ctx.lineWidth=Math.max(1,2*SCALE); roundedRectStroke(x,y,bw,bh,10*SCALE);
    ctx.fillStyle='#e6edf3'; ctx.textAlign='center'; ctx.fillText(txt, x+bw/2, y+bh/2 + 8*SCALE);
  }

  // overlays / textos
  if(state!=='playing' || showOverlay || !assetsReady){
    ctx.fillStyle='rgba(0,0,0,0.42)'; ctx.fillRect(0,0,world.w,world.h);
    ctx.fillStyle='#e6edf3'; ctx.textAlign='center';
    ctx.font=`700 ${Math.round(26*SCALE)}px system-ui`;
    const cx=world.w/2, cy=world.h/2;

    if(!assetsReady){
      ctx.fillText('Carregando imagens‚Ä¶', cx, cy-10*SCALE);
      ctx.font=`400 ${Math.round(16*SCALE)}px system-ui`; ctx.fillStyle='#9aa0a6';
      ctx.fillText('Verifique PNG/MP3 na pasta.', cx, cy+14*SCALE);

    } else if(state==='paused'){
      ctx.fillText('PAUSADO', cx, cy-10*SCALE);
      ctx.font=`400 ${Math.round(16*SCALE)}px system-ui`; ctx.fillStyle='#9aa0a6';
      ctx.fillText('Pressione ‚è∏Ô∏è novamente para continuar', cx, cy+16*SCALE);

    } else if(state==='countdown'){
      // Contagem 3-2-1
      const n = Math.max(1, Math.ceil(countdown));
      ctx.font=`900 ${Math.round(120*SCALE)}px system-ui`;
      ctx.fillStyle='#e6edf3';
      ctx.fillText(String(n), cx, cy + 40*SCALE);
      ctx.font=`400 ${Math.round(16*SCALE)}px system-ui`; ctx.fillStyle='#9aa0a6';
      ctx.fillText('Prepare-se‚Ä¶', cx, cy + 90*SCALE);

    } else if(state==='gameover'){
      ctx.fillText('Fim de jogo!', cx, cy-28*SCALE);

      // mensagem com jogadores salvos
      if(endMsg){
        const padX=16*SCALE, padY=10*SCALE;
        ctx.font=`600 ${Math.round(18*SCALE)}px system-ui`;
        const w=ctx.measureText(endMsg).width;
        const box={ x: cx - w/2 - padX, y: cy - 4*SCALE, w: w + 2*padX, h: 36*SCALE + padY };
        ctx.fillStyle='rgba(0,0,0,0.55)'; roundRect(box.x,box.y,box.w,box.h,10*SCALE,true);
        ctx.strokeStyle='#3a4659'; ctx.lineWidth=Math.max(1,1.5*SCALE); roundedRectStroke(box.x,box.y,box.w,box.h,10*SCALE);
        ctx.fillStyle='#e6edf3'; ctx.fillText(endMsg, cx, box.y + box.h/2 + 6*SCALE);
      }

      if(score>=best){
        const txt='üéâ Novo recorde!';
        ctx.font=`800 ${Math.round(22*SCALE)}px system-ui`; const w=ctx.measureText(txt).width;
        const bx=cx - w/2 - 18*SCALE, by=cy - 64*SCALE, bw=w+36*SCALE, bh=32*SCALE;
        ctx.fillStyle='rgba(0,0,0,.45)'; roundRect(bx,by,bw,bh,10*SCALE,true);
        ctx.strokeStyle='#3ddc97'; ctx.lineWidth=Math.max(1,2*SCALE); roundedRectStroke(bx,by,bw,bh,10*SCALE);
        ctx.fillStyle='#e6edf3'; ctx.fillText(txt, cx, by + bh/2 + 7*SCALE);
      }

      // Bot√µes: Reiniciar / Menu / Compartilhar
      const btnW = Math.round(200*SCALE), btnH = Math.round(46*SCALE);
      const gap = Math.round(16*SCALE);
      const totalW = btnW*3 + gap*2;
      const y = cy + Math.round(86*SCALE);
      let x = cx - totalW/2;

      function drawBtn(label){
        ctx.fillStyle='rgba(0,0,0,0.35)'; roundRect(x+3*SCALE, y+4*SCALE, btnW, btnH, 12*SCALE, true);
        const grad=ctx.createLinearGradient(x,y,x,y+btnH); grad.addColorStop(0,'#1f2632'); grad.addColorStop(1,'#121821');
        ctx.fillStyle=grad; roundRect(x,y,btnW,btnH,12*SCALE,true);
        ctx.strokeStyle='#3a4659'; ctx.lineWidth=Math.max(1,2*SCALE); roundedRectStroke(x,y,btnW,btnH,12*SCALE);
        ctx.font=`700 ${Math.round(16*SCALE)}px system-ui`; ctx.fillStyle='#e6edf3';
        ctx.fillText(label, x+btnW/2, y+btnH/2 + 6*SCALE);
        const rect={x,y,w:btnW,h:btnH}; x += btnW + gap; return rect;
      }

      overlayButtons = {
        restart: drawBtn('‚ü≤ Reiniciar'),
        menu:    drawBtn('üè† Menu'),
        share:   drawBtn('üîó Compartilhar')
      };

    } else {
      ctx.fillText('Pressione ‚ñ∂Ô∏è Jogar para come√ßar', cx, cy-8*SCALE);
      ctx.font=`400 ${Math.round(16*SCALE)}px system-ui`; ctx.fillStyle='#9aa0a6';
      ctx.fillText('Dica: mantenha o ritmo das batidas de asa', cx, cy+18*SCALE);
    }
  }

  // Toast
  if(toast){
    const txt=toast.msg;
    ctx.font=`700 ${Math.round(14*SCALE)}px system-ui`;
    const w=ctx.measureText(txt).width;
    const x = world.w - w - 24*SCALE, y = 24*SCALE, bw=w+16*SCALE, bh=28*SCALE;
    ctx.fillStyle='rgba(0,0,0,.5)'; roundRect(x-8*SCALE,y-18*SCALE,bw,bh,8*SCALE,true);
    ctx.fillStyle='#e6edf3'; ctx.fillText(txt, x, y);
  }
}

/* ===== Vidas como √≠cones ===== */
function drawLivesIcons(){
  if(!ASSETS.bird) return;
  const size = Math.round(28 * SCALE);
  const pad = Math.round(8 * SCALE);
  let x = pad, y = pad;
  for(let i=0;i<lives;i++){
    ctx.drawImage(ASSETS.bird, x, y, size, size);
    x += size + pad;
  }
}

/* ===== Fundo ===== */
function drawBackground(){
  if(ASSETS.bg){
    const img=ASSETS.bg, dstW=world.w, dstH=world.h;
    const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
    const srcR=iw/ih, dstR=dstW/dstH;
    let w,h; if(srcR>dstR){ w=dstW; h=w/srcR; } else { h=dstH; w=h*srcR; }
    const x=(dstW-w)/2, y=(dstH-h)/2;
    ctx.drawImage(img, x, y, w, h);
  }else{
    ctx.fillStyle='#0f1622'; ctx.fillRect(0,0,world.w,world.h);
  }
}

/* ===== Menu (top 5) ===== */
function drawMenu(){
  if(ASSETS.menu){
    const img=ASSETS.menu, dstW=world.w, dstH=world.h;
    const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height;
    const r1=iw/ih, r2=dstW/dstH; let w,h;
    if(r1>r2){ h=dstH; w=h*r1; } else { w=dstW; h=w/r1; }
    const x=-((w-dstW)/2), y=-((h-dstH)/2);
    ctx.drawImage(img, x, y, w, h);
  } else ctx.fillStyle='#0f1622', ctx.fillRect(0,0,world.w,world.h);

  ctx.fillStyle='rgba(0,0,0,0.25)'; ctx.fillRect(0,0,world.w,world.h);
  ctx.fillStyle='#e6edf3'; ctx.textAlign='center';
  ctx.font=`700 ${Math.round(38*SCALE)}px system-ui`;
  ctx.fillText('SALVE O FOG√ÉO DAS VENDAS PRO FOREST', world.w/2, world.h*0.18);

  const bw=Math.round(360*SCALE), bh=Math.round(100*SCALE);
  const base={x:(world.w-bw)/2, y:(world.h-bh)/2, w:bw, h:bh};
  const t=performance.now()/1000, pulse=1+0.04*Math.sin(t*4);
  const r={ x:base.x+(base.w*(1-pulse))/2, y:base.y+(base.h*(1-pulse))/2, w:base.w*pulse, h:base.h*pulse };

  ctx.fillStyle='rgba(0,0,0,0.35)'; roundRect(r.x+3*SCALE, r.y+5*SCALE, r.w, r.h, 16*SCALE, true);
  const grad=ctx.createLinearGradient(r.x, r.y, r.x, r.y+r.h); grad.addColorStop(0,'#1f2632'); grad.addColorStop(1,'#121821');
  ctx.fillStyle=grad; roundRect(r.x,r.y,r.w,r.h,16*SCALE,true);
  ctx.strokeStyle='#3a4659'; ctx.lineWidth=Math.max(1,2*SCALE); roundedRectStroke(r.x,r.y,r.w,r.h,16*SCALE);

  ctx.font=`800 ${Math.round(28*SCALE)}px system-ui`; ctx.fillStyle='#e6edf3';
  ctx.fillText('VAMOS COME√áAR', world.w/2, r.y+r.h/2 + 10*SCALE);

  const top=getTop();
  ctx.font=`700 ${Math.round(20*SCALE)}px system-ui`; ctx.fillText('üèÜ TOP 5', world.w/2, r.y + r.h + 48*SCALE);
  ctx.font=`400 ${Math.round(16*SCALE)}px system-ui`;
  for(let i=0;i<top.length;i++){
    const it=top[i];
    ctx.fillText(`${i+1}. ${it.n} ‚Äî ${it.s} jog.`, world.w/2, r.y + r.h + 80*SCALE + i*24*SCALE);
  }

  ctx.font=`400 ${Math.round(14*SCALE)}px system-ui`; ctx.fillStyle='#9aa0a6';
  ctx.fillText('Espa√ßo/Enter/click/toque para come√ßar', world.w/2, world.h-24*SCALE);
}

/* ===== Shapes ===== */
function drawPowerUps(){
  for(const u of powerups){
    const s=u.w;
    if(ASSETS.liberta){
      ctx.save(); ctx.translate(u.x+s/2, u.y+s/2); u.rot=(u.rot||0)+0.04; ctx.rotate(u.rot);
      ctx.drawImage(ASSETS.liberta, -s/2, -s/2, s, s); ctx.restore();
    } else { ctx.fillStyle='rgba(120,200,255,0.9)'; ctx.fillRect(u.x,u.y,s,s); }
  }
}
function drawGround(){
  const groundY=world.h-world.groundH;
  ctx.fillStyle='#0b121b'; ctx.fillRect(0,groundY,world.w,world.groundH);
  const t=world.scroll, tile=Math.round(40*SCALE), offset=-((t)%tile);
  ctx.fillStyle='#1f8f66';
  for(let x=offset-tile; x<world.w+tile; x+=tile){
    ctx.fillRect(x,groundY,Math.max(2,tile-Math.round(6*SCALE)),Math.max(6,Math.round(12*SCALE)));
  }
  ctx.strokeStyle='#1a2636'; ctx.lineWidth=Math.max(1,1*SCALE);
  ctx.beginPath(); ctx.moveTo(0,groundY+0.5); ctx.lineTo(world.w,groundY+0.5); ctx.stroke();
}
function drawPipe(p){
  const r=10*SCALE; ctx.save(); ctx.beginPath(); roundedRectPath(p.x,p.y,p.w,p.h,r); ctx.clip();
  const grad=ctx.createLinearGradient(p.x,p.y,p.x+p.w,p.y); grad.addColorStop(0,'#c01220'); grad.addColorStop(1,'#8f0f1a');
  ctx.fillStyle=grad; ctx.fillRect(p.x,p.y,p.w,p.h);
  ctx.fillStyle='#e01e2a'; const capH=Math.round(14*SCALE);
  if(p.isTop) ctx.fillRect(p.x-6*SCALE,p.h-capH,p.w+12*SCALE,capH);
  else        ctx.fillRect(p.x-6*SCALE,p.y,     p.w+12*SCALE,capH);

  const img = p.skin==='marinakis' ? ASSETS.marinakis : ASSETS.forest;
  if(assetsReady && img){
    const step=Math.round(90*SCALE), iconW=Math.round(46*SCALE), iconH=Math.round(46*SCALE);
    const y0=p.isTop?(p.y+16*SCALE):(p.y+capH+6*SCALE);
    const y1=p.isTop?(p.h-capH-6*SCALE):(p.y+p.h-16*SCALE);
    for(let yy=y0; yy<y1-iconH; yy+=step){ ctx.drawImage(img, p.x+(p.w-iconW)/2, yy, iconW, iconH); }
  }
  ctx.restore(); ctx.strokeStyle='#5f0d16'; ctx.lineWidth=Math.max(1,2*SCALE); roundedRectStroke(p.x,p.y,p.w,p.h,r);
}
function drawBird(){
  const ang=clamp(bird.vy/600,-0.6,0.8);
  const cx=bird.x+bird.w/2, cy=bird.y+bird.h/2;
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(ang);
  if(assetsReady && ASSETS.bird){ ctx.drawImage(ASSETS.bird,-bird.w/2,-bird.h/2,bird.w,bird.h); }
  else { ctx.fillStyle='#fff'; roundRect(-bird.w/2,-bird.w/2,bird.w,bird.h,10*SCALE,true); }
  ctx.restore();
}
function roundedRectPath(x,y,w,h,r){
  const rr=Math.min(r,w/2,h/2); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();
}
function roundedRectStroke(x,y,w,h,r){ ctx.beginPath(); roundedRectPath(x,y,w,h,r); ctx.stroke(); }
function roundRect(x,y,w,h,r,fill=true){ const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); fill?ctx.fill():ctx.stroke(); }

/* ===== Inicial ===== */
setMuted(false);
fitCanvas();
goMenu();
</script>
</body>
</html>
